# Aiken

Install Aiken from https://aiken-lang.org/installation-instructions

## Hello World Script

This "Hello World" example the validator only allows us to withdraw the funds if the redeemer is "Hello World" and if the person defined in the datum signs the transaction. The [Hello World](../hello-world/validators/hello-world.ak) Script!


```aiken
use aiken/collection/list
use aiken/crypto.{VerificationKeyHash}
use cardano/transaction.{OutputReference, Transaction}

pub type Datum {
  owner: VerificationKeyHash,
}

pub type Redeemer {
  msg: ByteArray,
}

validator hello_world {
  spend(
    datum: Option<Datum>,
    redeemer: Redeemer,
    _own_ref: OutputReference,
    self: Transaction,
  ) {
    expect Some(Datum { owner }) = datum
    let must_say_hello = redeemer.msg == "Hello, World!"
    let must_be_signed = list.has(self.extra_signatories, owner)
    must_say_hello && must_be_signed
  }

  else(_) {
    fail
  }
}
```

Running `aiken check` will install dependencies, type-check your Aiken project and run any tests found.

```shell
aiken check
```
```shell
    Compiling rare/hello-world 0.0.0 (.)
    Compiling aiken-lang/stdlib v2.2.0 (./build/packages/aiken-lang-stdlib)
   Collecting all tests scenarios across all modules
      Summary 0 errors, 0 warnings
```

Now, `aiken build` will compile the script and generate a `plutus.json` blueprint
```shell
aiken build
```

```
    Compiling rare/hello-world 0.0.0 (.)
    Compiling aiken-lang/stdlib v2.2.0 (./build/packages/aiken-lang-stdlib)
   Generating project's blueprint (./plutus.json)
      Summary 0 errors, 0 warnings
```

```plutus.json
{
  "preamble": {
    "title": "rare/hello-world",
    "description": "Aiken contracts for project 'rare/hello-world'",
    "version": "0.0.0",
    "plutusVersion": "v3",
    "compiler": {
      "name": "Aiken",
      "version": "v1.1.17+cd288d4"
    },
    "license": "Apache-2.0"
  },
  "validators": [
    {
      "title": "hello_world.hello_world.spend",
      "datum": {
        "title": "datum",
        "schema": {
          "$ref": "#/definitions/hello_world~1Datum"
        }
      },
      "redeemer": {
        "title": "redeemer",
        "schema": {
          "$ref": "#/definitions/hello_world~1Redeemer"
        }
      },
      "compiledCode": "59010601010029800aba2aba1aab9faab9eaab9dab9a48888896600264646644b30013370e900118031baa00189919912cc004cdc3a400060126ea801626464b3001300f0028acc004cdc3a400060166ea800e2b30013371e6eb8c038c030dd5003a450d48656c6c6f2c20576f726c642100899199119801001000912cc00400629422b30013371e6eb8c04400400e2946266004004602400280690101bac300f30103010301030103010301030103010300d3754601e0146eb8c038c030dd5180718061baa0038a5040291640291640346eb8c034004c028dd5002c5900818050009805180580098039baa0018b200a30070013007300800130070013003375400f149a26cac80081",
      "hash": "2499e3a64ae4228a1e63ce6f131b279487d9780f132a0698e8b1f0f2"
    },
    {
      "title": "hello_world.hello_world.else",
      "redeemer": {
        "schema": {}
      },
      "compiledCode": "59010601010029800aba2aba1aab9faab9eaab9dab9a48888896600264646644b30013370e900118031baa00189919912cc004cdc3a400060126ea801626464b3001300f0028acc004cdc3a400060166ea800e2b30013371e6eb8c038c030dd5003a450d48656c6c6f2c20576f726c642100899199119801001000912cc00400629422b30013371e6eb8c04400400e2946266004004602400280690101bac300f30103010301030103010301030103010300d3754601e0146eb8c038c030dd5180718061baa0038a5040291640291640346eb8c034004c028dd5002c5900818050009805180580098039baa0018b200a30070013007300800130070013003375400f149a26cac80081",
      "hash": "2499e3a64ae4228a1e63ce6f131b279487d9780f132a0698e8b1f0f2"
    }
  ],
  "definitions": {
    "ByteArray": {
      "dataType": "bytes"
    },
    "aiken/crypto/VerificationKeyHash": {
      "title": "VerificationKeyHash",
      "dataType": "bytes"
    },
    "hello_world/Datum": {
      "title": "Datum",
      "anyOf": [
        {
          "title": "Datum",
          "dataType": "constructor",
          "index": 0,
          "fields": [
            {
              "title": "owner",
              "$ref": "#/definitions/aiken~1crypto~1VerificationKeyHash"
            }
          ]
        }
      ]
    },
    "hello_world/Redeemer": {
      "title": "Redeemer",
      "anyOf": [
        {
          "title": "Redeemer",
          "dataType": "constructor",
          "index": 0,
          "fields": [
            {
              "title": "msg",
              "$ref": "#/definitions/ByteArray"
            }
          ]
        }
      ]
    }
  }
}
```

To convert it to a format that cardano-cli understands, run 

```shell
aiken blueprint convert > hello-world.json
```
```hello-world.json
{
  "type": "PlutusScriptV3",
  "description": "Generated by Aiken",
  "cborHex": "59010959010601010029800aba2aba1aab9faab9eaab9dab9a48888896600264646644b30013370e900118031baa00189919912cc004cdc3a400060126ea801626464b3001300f0028acc004cdc3a400060166ea800e2b30013371e6eb8c038c030dd5003a450d48656c6c6f2c20576f726c642100899199119801001000912cc00400629422b30013371e6eb8c04400400e2946266004004602400280690101bac300f30103010301030103010301030103010300d3754601e0146eb8c038c030dd5180718061baa0038a5040291640291640346eb8c034004c028dd5002c5900818050009805180580098039baa0018b200a30070013007300800130070013003375400f149a26cac80081"
}
```

### Locking funds in the script
For this example, we also need to build the address of `delegator2`
```
cardano-cli conway address build \
  --payment-verification-key-file mytestnet/stake-delegators/delegator2/payment.vkey \
  --stake-verification-key-file mytestnet/stake-delegators/delegator2/staking.vkey \
  --testnet-magic 42 \
  --out-file mytestnet/stake-delegators/delegator2/payment.addr 
```

Lets go back to the root of the repo, from there, generate the script address with

```shell
cardano-cli conway address build \
  --payment-script-file hello-world/hello-world.json \
  --out-file mytestnet/hello-world.addr
```

```shell
cat mytestnet/hello-world.addr
```

Let us make `delegator1` to lock 900 ada in the script address and make `delegator2` the owner of the funds:

```shell
cardano-cli conway query utxo --address $(< mytestnet/stake-delegators/delegator1/payment.addr) --output-text
```

Let's use the utxo with a balance of 1000 ada
```shell

                           TxHash                                 TxIx        Amount
--------------------------------------------------------------------------------------
c243afe5e5cb1823d48bdd9d7f97bf99dfdb5c50c2cdaf7f1d33b1a23bd62144     0        15000003000000 lovelace + TxOutDatumNone
efbdac0855cff1fffbb2c9d6b0e7dadc66bf50af7f29230f87d674ad86c60bd5     0        1000000000 lovelace + TxOutDatumNone
```

But before creating the transaction, we have to know the `Public Key Hash` of the owner (`delegator2`).

```
    cardano-cli address key-hash --payment-verification-key-file mytestnet/stake-delegators/delegator2/payment.vkey | sed 's/.*/"&"/'  | jq -c '{constructor: 0, fields:[{bytes: .}]}' > datum.json
cat datum.json
```

```
{"constructor":0,"fields":[{"bytes":"5707cc613f60df4c0d876a157cfc3f0a06ed435fa8d302c603e11941"}]}
```


Build the transaction, use the script address on the ouput:
```shell
cardano-cli conway transaction build \
  --tx-in $(cardano-cli conway query utxo --address $(< mytestnet/stake-delegators/delegator1/payment.addr) | jq -r 'keys[0]') \
  --tx-out $(< mytestnet/hello-world.addr)+900000000 \
  --tx-out-inline-datum-file datum.json \
  --change-address $(< mytestnet/stake-delegators/delegator1/payment.addr) \
  --out-file mytestnet/tx.raw
```
Sign the transaction

```shell
cardano-cli conway transaction sign \
  --tx-file mytestnet/tx.raw \
  --signing-key-file mytestnet/stake-delegators/delegator1/payment.skey \
  --out-file mytestnet/tx.signed 
```

And submit it

```shell
cardano-cli conway transaction submit --tx-file mytestnet/tx.signed
```

Now we have 

```shell
cardano-cli conway query utxo --address $(< mytestnet/hello-world.addr) 
```
```json
{
    "a3b214e3382daabdae552fbe1719c3e568218942c6be043425d4fed8491b190a#0": {
        "address": "addr_test1wrf8enqnl26m0q5cfg73lxf4xxtu5x5phcrfjs0lcqp7uagh2hm3k",
        "datum": null,
        "datumhash": "5e616ae3e8f19d5e81becbd92022c22bb398e3e91499809173c61cb0d69aea92",
        "inlineDatum": null,
        "inlineDatumRaw": null,
        "referenceScript": null,
        "value": {
            "lovelace": 900000000
        }
    }
}
```
Now, let's try to spend from the script address:

We'll use almost the same transaction than the one used in the always-true example, but this time the redeemer matters, it has to contain the message "Hello, World!". We will save this using the following command

```
jq -c '{constructor:0,fields:[{bytes:.}]}' <<< "\"$(echo 'Hello, World!' | xxd -g1 | cut -d ' ' -f2-14  | tr -d ' ')\"" | tee redeemer.json
```
With this command we added the string "Hello, World!" in structure, but it has to be converted into hexadecimal. The result is the following:

```
cat redeemer.json
```
```
{"constructor":0,"fields":[{"bytes":"48656c6c6f2c20576f726c6421"}]}
```

Where the string `48656c6c6f2c20576f726c6421` is the hexadecimal equivalent to `Hello, World!`

```shell
cardano-cli conway transaction build \
  --tx-in-collateral $(cardano-cli conway query utxo --address $(< mytestnet/stake-delegators/delegator2/payment.addr) | jq -r 'keys[0]') \
  --tx-in $(cardano-cli conway query utxo --address $(< mytestnet/hello-world.addr) | jq -r 'keys[0]') \
  --tx-in-script-file hello-world/hello-world.json \
  --tx-in-inline-datum-present \
  --tx-in-redeemer-file redeemer.json \
  --change-address $(< mytestnet/stake-delegators/delegator1/payment.addr) \
  --required-signer mytestnet/stake-delegators/delegator2/payment.skey \
  --out-file mytestnet/unlocktx.raw
```
To build the transaction the validator needs to know that `delegator2` will sign the transaction. To do that, we set the argument `--required-signer` and give the signing key of `delegator2`.

Notice that this time `delegator2` will unlock the funds from the script, and also `delegator2` will sign the transaction:

```shell
cardano-cli conway transaction sign \
  --tx-file  mytestnet/unlocktx.raw \
  --signing-key-file mytestnet/stake-delegators/delegator2/payment.skey \
  --out-file mytestnet/unlocktx.signed
```
```shell
cardano-cli conway transaction submit \
  --tx-file mytestnet/unlocktx.signed
```
