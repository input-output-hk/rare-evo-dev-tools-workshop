# Aiken

Install Aiken from https://aiken-lang.org/installation-instructions

## AlwaysTrue Script

Arugably the simplest script you can build with Aiken. The [Always True](../alwaystrue/validators/always-true.ak) Script!


```aiken
use cardano/transaction.{OutputReference, Transaction}

validator alwaysTrue {
  spend(
    _datum: Option<Data>,
    _redeemer: Data,
    _utxo: OutputReference,
    _self: Transaction,
  ) {
    True
  }

  else(_) {
    fail
  }
}
```

Running `aiken check` will install dependencies, type-check your Aiken project and run any tests found.

```shell
aiken check
```
```shell
    Compiling rare/alwaystrue 0.0.0 (.)
    Compiling aiken-lang/stdlib v2.2.0 (./build/packages/aiken-lang-stdlib)
   Collecting all tests scenarios across all modules
      Summary 0 errors, 0 warnings
```

Now, `aiken build` will compile the script and generate a `plutus.json` blueprint
```shell
aiken build
```

```
    Compiling rare/alwaystrue 0.0.0 (.)
    Compiling aiken-lang/stdlib v2.2.0 (./build/packages/aiken-lang-stdlib)
   Generating project's blueprint (./plutus.json)
      Summary 0 errors, 0 warnings
```

```plutus.json
{
  "preamble": {
    "title": "rare/alwaystrue",
    "description": "Aiken contracts for project 'rare/alwaystrue'",
    "version": "0.0.0",
    "plutusVersion": "v3",
    "compiler": {
      "name": "Aiken",
      "version": "v1.1.17+c3a7fba"
    },
    "license": "Apache-2.0"
  },
  "validators": [
    {
      "title": "always_true.alwaysTrue.spend",
      "datum": {
        "title": "_datum",
        "schema": {
          "$ref": "#/definitions/Data"
        }
      },
      "redeemer": {
        "title": "_redeemer",
        "schema": {
          "$ref": "#/definitions/Data"
        }
      },
      "compiledCode": "585c01010029800aba2aba1aab9eaab9dab9a4888896600264653001300600198031803800cc0180092225980099b8748008c01cdd500144c8cc892898050009805180580098041baa0028b200c180300098019baa0068a4d13656400401",
      "hash": "d27ccc13fab5b782984a3d1f99353197ca1a81be069941ffc003ee75"
    },
    {
      "title": "always_true.alwaysTrue.else",
      "redeemer": {
        "schema": {}
      },
      "compiledCode": "585c01010029800aba2aba1aab9eaab9dab9a4888896600264653001300600198031803800cc0180092225980099b8748008c01cdd500144c8cc892898050009805180580098041baa0028b200c180300098019baa0068a4d13656400401",
      "hash": "d27ccc13fab5b782984a3d1f99353197ca1a81be069941ffc003ee75"
    }
  ],
  "definitions": {
    "Data": {
      "title": "Data",
      "description": "Any Plutus data."
    }
  }
}
```

To convert it to a format that cardano-cli understands, run 

```shell
aiken blueprint convert > alwaystrue.json
```
```alwaystrue.json
{
  "type": "PlutusScriptV3",
  "description": "Generated by Aiken",
  "cborHex": "585e585c01010029800aba2aba1aab9eaab9dab9a4888896600264653001300600198031803800cc0180092225980099b8748008c01cdd500144c8cc892898050009805180580098041baa0028b200c180300098019baa0068a4d13656400401"
}
```

### Locking funds in the script

Lets go back to the root of the repo, from there, generate the script address with

```shell
cardano-cli conway address build \
  --payment-script-file alwaystrue/alwaystrue.json \
  --out-file mytestnet/alwaystrue.addr
```

```shell
cat mytestnet/alwaystrue.addr
```

Let us make `delegator1` to lock 900 ada in the script address:

```shell
cardano-cli conway query utxo --address $(< mytestnet/stake-delegators/delegator1/payment.addr) --output-text
```

Let's use the utxo with a balance of 1000 ada
```shell

                           TxHash                                 TxIx        Amount
--------------------------------------------------------------------------------------
c243afe5e5cb1823d48bdd9d7f97bf99dfdb5c50c2cdaf7f1d33b1a23bd62144     0        15000003000000 lovelace + TxOutDatumNone
efbdac0855cff1fffbb2c9d6b0e7dadc66bf50af7f29230f87d674ad86c60bd5     0        1000000000 lovelace + TxOutDatumNone
```

Build the transaction, use the script address on the ouput:
```shell
cardano-cli conway transaction build \
  --tx-in $(cardano-cli conway query utxo --address $(< mytestnet/stake-delegators/delegator1/payment.addr) | jq -r 'keys[1]') \
  --tx-out $(< mytestnet/alwaystrue.addr)+900000000 \
  --tx-out-datum-embed-value 404 \
  --change-address $(< mytestnet/stake-delegators/delegator1/payment.addr) \
  --out-file mytestnet/tx.raw
```
Sign the transaction

```shell
cardano-cli conway transaction sign \
  --tx-file mytestnet/tx.raw \
  --signing-key-file mytestnet/stake-delegators/delegator1/payment.skey \
  --out-file mytestnet/tx.signed 
```

And submit it

```shell
cardano-cli conway transaction submit --tx-file mytestnet/tx.signed
```

Now we have 

```shell
cardano-cli conway query utxo --address $(< mytestnet/alwaystrue.addr) 
```
```json
{
    "a3b214e3382daabdae552fbe1719c3e568218942c6be043425d4fed8491b190a#0": {
        "address": "addr_test1wrf8enqnl26m0q5cfg73lxf4xxtu5x5phcrfjs0lcqp7uagh2hm3k",
        "datum": null,
        "datumhash": "5e616ae3e8f19d5e81becbd92022c22bb398e3e91499809173c61cb0d69aea92",
        "inlineDatum": null,
        "inlineDatumRaw": null,
        "referenceScript": null,
        "value": {
            "lovelace": 900000000
        }
    }
}
```
Now, let's try to spend from the script address:

```shell
cardano-cli conway transaction build \
  --tx-in-collateral $(cardano-cli conway query utxo --address $(< mytestnet/stake-delegators/delegator1/payment.addr) | jq -r 'keys[0]') \
  --tx-in $(cardano-cli conway query utxo --address $(< mytestnet/alwaystrue.addr) | jq -r 'keys[0]') \
  --tx-in-script-file alwaystrue/alwaystrue.json \
  --tx-in-datum-value 404 \
  --tx-in-redeemer-value {} \
  --change-address $(< mytestnet/stake-delegators/delegator1/payment.addr) \
  --out-file mytestnet/unlocktx.raw
```

```shell
cardano-cli conway transaction sign \
  --tx-file  mytestnet/unlocktx.raw \
  --signing-key-file mytestnet/stake-delegators/delegator1/payment.skey \
  --out-file mytestnet/unlocktx.signed
```
```shell
cardano-cli conway transaction submit \
  --tx-file mytestnet/unlocktx.signed
```




